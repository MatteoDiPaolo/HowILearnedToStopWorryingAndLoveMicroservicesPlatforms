<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<link rel="icon" href="/favicon.ico" />
	<title>How I Learned To Stop Worrying And Love Microservices Platforms</title>

	<meta name="description" content="Talk about Microservices Platforms">
	<meta name="author" content="Matteo Di Paolo">

	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="css/reset.css">
	<link rel="stylesheet" href="css/reveal.css">
	<link rel="stylesheet" href="css/theme/black.css" id="theme">

	<!-- Theme used for syntax highlighting of code -->
	<link rel="stylesheet" href="lib/css/monokai.css">

	<link rel="stylesheet" href="index.css">

	<!-- Printing and PDF exports -->
	<script>
		var link = document.createElement('link');
		link.rel = 'stylesheet';
		link.type = 'text/css';
		link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
		document.getElementsByTagName('head')[0].appendChild(link);
	</script>

	<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
</head>

<body>

	<div class="reveal">

		<!-- Any section element inside of this container is displayed as a slide -->
		<div class="slides">
			<section>
				<h3>How I Learned To Stop Worrying And Love Microservices Platforms</h3>
				<small>Business logic related code is not everything</small>
				<br>
				<img style="margin: 0px !important; border: 0px !important; opacity: 0.8; background-color: transparent; box-shadow: none;"
					height="300" data-src="./images/1.png" alt="...">
				<p>
					<small style="text-align: left; margin-right: 40px;">Matteo Di Paolantonio</small>
					<small class="gs-text" style="text-align: right; margin-left: 40px;">28/05/2021</small>
				</p>

				<aside class="notes">
					Managing a microservices platform is like riding a nuke <br>
				</aside>
			</section>

			<section>
				<h2>Agenda</h2>
				<ol>
					<li><span>Microservices Platforms</span></li>
					<li><span>Docs and Validation</span></li>
					<li><span>Monitoring and Alerting</span></li>
					<li><span>Testing</span></li>
				</ol>
			</section>

			<section>
				<section>
					<h2>Microservices Platforms</h2>
					Black Box
					<br>
					<img width="460" height="200" data-src="/images/2.png" alt="...">

					<aside class="notes">
						Input: human / machine - sync / async <br>
						Output: human / machine - sync / async <br>
					</aside>
				</section>

				<section>
					<h2>Microservices Platforms</h2>
					Grey Box
					<br>
					<img height="400" data-src="/images/3.png" alt="...">

					<aside class="notes">
						micro black boxes inside of it that are going to work as well with micro inputs and micro
						outputs <br>
					</aside>
				</section>

				<section>
					<h2>Micro black boxes</h2>
					<small>Artifacts</small>
					<div>
						<ul>
							<li><span>Business logic related code <span class="gs-text">Adapter - Rest API</span></span>
							</li>
							<li><span>Deployed somewhere <span class="gs-text">k8s - ECS</span></span></li>
							<li><span>Relying on infra <span class="gs-text">DBs - Message Brokers - Key
										Vaults</span></span></li>
						</ul>
					</div>

					<aside class="notes">
						the architecture diagram is super important <br>
					</aside>
				</section>

				<section>
					<h2>Lifecycle events</h2>
					<small>Generated by the Business Logic</small>
					<div>
						<ul>
							<li><span><span class="gs-text">PERFORMACE</span> - Micro black boxes usage</span></li>
							<li><span><span class="gs-text">INFRASTRUCTURE</span> - Infrastructure pieces usage</span>
							<li><span><span class="gs-text">INGESTION</span> - Inbound data flow</span></li>
							<li><span><span class="gs-text">RETRIEVAL</span> - Outbound data flow</span></li>
							</li>
						</ul>
					</div>

					<aside class="notes">
						the architecture diagram should picture that <br>
					</aside>
				</section>
			</section>

			<section>
				<section>
					<h2>Docs and Validation</h2>
					<small>Security Net and a Common Language</small>
					<br>
					<img height="400" data-src="/images/4.gif" alt="...">
				</section>

				<section>
					<h2>Sync interfaces docs</h2>
					<img height="400" data-src="/images/5.png" alt="...">

					<aside class="notes">
						forced to think a lot about the correct behaviour of the interface <br>
						http://10.121.16.217/api-docs/#/ <br>
						http://10.121.16.217/api-docs/#/Nike%20data%20processing%20v2/get_v2_packages__packageId__translationsHistory <br>
						84863df5-2748-423d-b873-3bfe449af8a9 <br>
					</aside>
				</section>

				<section>
					<h2>Sync interfaces docs</h2>
					<img height="400" data-src="/images/6.png" alt="...">

					<aside class="notes">
						http://10.121.17.149/voyager <br>
					</aside>
				</section>

				<section>
					<h2>Sync interfaces validation</h2>
					<pre style="font-size: 12px; margin-top: 0;"><code class="hljs js" style="word-wrap: break-word;">
/**
* GET /v2/packages/{packageId}/translationsHistory
* @summary This endpoint returns the package's translation history
* @tags Nike data processing v2
* @param {string} packageId.path.required Package ID
* @param {number} offset.query Offset (default: 0)
* @param {number} limit.query Limit (default: 50)
* @return {TranslationsHistoryResponse} 200 - Successful response
* @return {ErrorServerResponse} 500 - Server error
* @return {NotFoundResponse} 404 - Not found
* @return {BadRequestResponse} 400 - Bad request
*/
app.get('/v2/packages/:packageId/translationsHistory', ExpressJoi({
	params: {
		packageId: Joi.string().regex(/^[a-zA-Z0-9-_.]+$/).required(),
	},
	query: {
		offset: Joi.number().min(0).optional(),
		limit: Joi.number().min(1).optional(),
	},
}), async (req, res, next) => {
	const { packageId } = req.params;
	const { offset, limit } = req.query;

	try {
		const translationsHistory = await controller.v2.api.getTranslationsHistory(packageId, offset, limit);
		return res.json(translationsHistory);
	} catch (err) {
		if (err.message === 'content_not_found') return next(tagError({ type: 'not_found', message: `Translation history for package ${packageId} was not found` }));
		return next(tagError(err));
	}
});
					</code></pre>

					<aside class="notes">
						forced to think a lot about the correct behaviour of the interface <br>
						http://10.121.16.217/api-docs/#/ <br>
						http://10.121.16.217/api-docs/#/Nike%20data%20processing%20v2/get_v2_packages__packageId__translationsHistory <br>
						wrong*input*id <br>
					</aside>
				</section>

				<section>
					<h2>Async interfaces docs</h2>
					<img height="400" data-src="/images/7.png" alt="...">

					<aside class="notes">
						forced to think a lot about the correct behaviour of the interface <br>
						http://10.121.17.87/__/docs/bus/#operation-subscribe-ecommerce-proxy.v1.shippingcost.updated <br>
					</aside>
				</section>

				<section>
					<h2>Async interfaces validation</h2>
					<pre style="font-size: 12px; margin-top: 0;"><code class="language-yaml" style="word-wrap: break-word;">
channels:
  ecommerce-proxy.v1.shippingcost.updated:
    subscribe:
      summary: Subscribe to information about a shippingcost updated v1
      operationId: integrationsShippingcostUpdated
      message:
      $ref: "#/components/messages/ecommerce-proxy-v1-shippingcost-updated"
components:
  messages:
    integrations-adapter-v2-shippingcost-updated:
      contentType: application/json
      payload:
      $ref: "#/components/schemas/integrations-adapter-v2-shippingcost-updated-message-schema"
  schemas:
    integrations-adapter-v2-shippingcost-updated-message-schema:
      type: object
      required:
      - lastUpdatedTimestamp
      - type
      - isInactive
      - shippingTable
      properties:
        lastUpdatedTimestamp:
          type: string
          description: timestamp of the last update operation over the shippingcost made in integrations
        type:
          type: string
          description: shippingcost id
        isInactive:
          type: boolean
          description: shippingcost active flag
        shippingTable:
          type: array
          description: shipping table with ranges and charges
          items:
            type: object
          required:
            - range
            - charge
          properties:
            range:
              type: string
              description: range minimum order cost
            charge:
              type: number
              description: charge to apply to the minimum order cost
					</code></pre>

					<aside class="notes">
						forced to think a lot about the correct behaviour of the interface <br>
					</aside>
				</section>

				<section>
					<h2>Async interfaces validation</h2>
					<pre style="font-size: 12px; margin-top: 0;"><code class="hljs js" style="word-wrap: break-word;">
const updateShippingCost = subscription => async ({ body: integrationsShippingCost }) => {
	const shippingCostType = integrationsShippingCost.shippingTableChargeBy

	try {
		validator.validateSubscribePayload(subscription, integrationsShippingCost)
		logger.info(`Subscription: ${subscription} message processing started for shippingCost: ${shippingCostType}`)

		const storedShippingCost = await mongodb.v2.shippingcosts.getShippingCostByType(shippingCostType)
		const shouldNotUpsert = storedShippingCost ? storedShippingCost.lastUpdateTimestamp >= integrationsShippingCost.lastUpdated : false

		if (shouldNotUpsert) {
		logger.info(`Subscription: ${subscription} message processing skipped for shippingCost: ${shippingCostType}`)
		return
		}

		const shippingCost = parser(integrationsShippingCost)
		await mongodb.v2.shippingcosts.upsertShippingCost(shippingCost)
		await bus.v2.ecommerce.publish('shippingCostUpdated')(shippingCost)
		monitor.trackShippingCostUpdatedSuccess()
		logger.info(`Subscription: ${subscription} message processing succeed for shippingCost: ${shippingCostType}`)
	} catch (err) {
		monitor.trackShippingCostUpdatedFail()
		logger.error(`Subscription: ${subscription} message processing failed for shippingCost: ${shippingCostType}. Error: ${err.message}`)
		throw err
	}
}
					</code></pre>

					<aside class="notes">
						forced to think a lot about the correct behaviour of the interface <br>
					</aside>
				</section>

				<section>
					<h2>Backoffice sync interfaces</h2>
					<img height="400" data-src="/images/8.png" alt="...">

					<aside class="notes">
						useful for other stakeholders with less coding skills / access rights<br>
						http://10.121.16.217/__/manifest <br>
						http://10.121.16.217/__/health <br>
						http://10.121.16.217/api-docs/#/ <br>
						http://10.121.16.217/api-docs/#/Nike%20data%20processing%20v2/get_v2_packages__packageId__translationsHistory <br>
						84863df5-2748-423d-b873-3bfe449af8a9 <br>
					</aside>
				</section>

				<section>
					<h2>Ad hoc docs</h2>
					<img height="400" data-src="/images/9.png" alt="...">

					<aside class="notes">
						useful for other stakeholders with less coding skills / access rights<br>
						created from unit tests fixtures<br>
						updated on each build and served as a static page<br>
						https://discodocsdevelopment.z6.web.core.windows.net/ <br>
						https://dev.azure.com/infinitas/LI.DISCO/_dashboards/dashboard/649586fb-cec4-4344-af91-f3d2874f7a34  <br>
					</aside>
				</section>
			</section>

			<section>
				<section>
					<h2>Monitoring and Alerting</h2>
					<small>Security Net and a Common Language</small>
					<br>
					<img height="400" data-src="/images/10.gif" alt="...">
				</section>

				<section>
					<h2>Events</h2>
					<div>
						<ul>
							<li>
								<span class="gs-text">PERFORMACE</span>
								<ul>
									<li><span>cpu / memory consumption</span></li>
									<li><span>restarts</span></li>
								</ul>
							</li>
							<li>
								<span class="gs-text">INFRASTRUCTURE</span>
								<ul>
									<li><span>DBs / Storages / Buckets usage</span></li>
									<li><span>Message Broker status</span></li>
								</ul>
							</li>
							<li>
								<span class="gs-text">INGESTION</span>
								<ul>
									<li><span>content deltas / processed / indexed</span></li>
								</ul>
							</li>
							<li>
								<span class="gs-text">RETRIEVAL</span>
								<ul>
									<li><span>content retrieved / requested / published</span></li>
								</ul>
							</li>
						</ul>
					</div>

					<aside class="notes">
						weekly fighter task to review it<br>
						mixing all the info in them we can identify issues<br>
						mission control panel<br>
					</aside>
				</section>

				<section>
					<h2>Azure setup</h2>
					<img data-src="/images/11.png" alt="...">

					<aside class="notes">
						just an example<br>
						grafana<br>
					</aside>
				</section>

				<section>
					<h2>PERFORMACE</h2>
					<img data-src="/images/12.png" alt="...">

					<aside class="notes">
						https://portal.azure.com/#@infinitaslearning.onmicrosoft.com/dashboard/arm/subscriptions/4ebd66c4-aaad-4b1b-bb4e-740db9f1fc4d/resourceGroups/disco-production-rg/providers/Microsoft.Portal/dashboards/disco-performance-production<br>
					</aside>
				</section>

				<section>
					<h2>INFRASTRUCTURE</h2>
					<img data-src="/images/13.png" alt="...">

					<aside class="notes">
						https://portal.azure.com/#@infinitaslearning.onmicrosoft.com/dashboard/arm/subscriptions/4ebd66c4-aaad-4b1b-bb4e-740db9f1fc4d/resourceGroups/disco-production-rg/providers/Microsoft.Portal/dashboards/disco-infrastructure-production<br>
					</aside>
				</section>

				<section>
					<h2>INGESTION</h2>
					<img data-src="/images/14.png" alt="...">

					<aside class="notes">
						https://portal.azure.com/#@infinitaslearning.onmicrosoft.com/resource/subscriptions/4ebd66c4-aaad-4b1b-bb4e-740db9f1fc4d/resourceGroups/disco-production-rg/providers/Microsoft.Portal/dashboards/disco-digestion-production/overview<br>
					</aside>
				</section>

				<section>
					<h2>RETRIEVAL</h2>
					<img data-src="/images/15.png" alt="...">

					<aside class="notes">
						https://portal.azure.com/#@infinitaslearning.onmicrosoft.com/dashboard/arm/subscriptions/4ebd66c4-aaad-4b1b-bb4e-740db9f1fc4d/resourceGroups/disco-development-rg/providers/Microsoft.Portal/dashboards/disco-retrieval-development<br>
					</aside>
				</section>

				<section>
					<h2>RETRIEVAL</h2>
					<img data-src="/images/16.png" alt="...">

					<aside class="notes">
						https://portal.azure.com/#@infinitaslearning.onmicrosoft.com/dashboard/arm/subscriptions/4ebd66c4-aaad-4b1b-bb4e-740db9f1fc4d/resourceGroups/disco-production-rg/providers/Microsoft.Portal/dashboards/disco-endpoints-party-production<br>
					</aside>
				</section>

				<section>
					<h2>Alerts</h2>
					<img data-src="/images/17.png" alt="...">
					<img data-src="/images/18.png" alt="...">

					<aside class="notes">
						here we use logic apps, you can use what you want<br>
					</aside>
				</section>
			</section>

			<section>
				<section>
					<h2>Testing</h2>
					<small>Security Net and a Common Language</small>
					<br>
					<img height="400" data-src="/images/19.gif" alt="...">
				</section>

				<section>
					<h2>Business logic flows</h2>
					<img data-src="/images/20.png" alt="...">

					<aside class="notes">
						Input / output<br>
						Data parsing and transformation<br>
					</aside>
				</section>

				<section>
					<h2>Integration Async</h2>
					<pre style="font-size: 12px; margin-top: 0;"><code class="hljs js" style="word-wrap: break-word;">
describe('[Integration-Tests] - V2 BUS - Shipping cost', async () => {
	it('Should process integrations shipping cost', async () => {
		const shippingCostType = integrationsShippingCost.shippingTableChargeBy
		await busComponent.v2.integrations.publish('shippingCostUpdated')(integrationsShippingCost)
		await sleep(500)

		const storedShippingCost = await storeComponent.v2.shippingcosts.getShippingCostByType(shippingCostType)
		expect(storedShippingCost).toEqual(ecommerceShippingCost)
	})
})
					</code></pre>
				</section>

				<section>
					<h2>Integration Sync</h2>
					<pre style="font-size: 12px; margin-top: 0;"><code class="hljs js" style="word-wrap: break-word;">
describe('[Integration-Tests] - V2 API - Endpoint: /v2/packages/{id}/translationsHistory', async () => {
	it('Should retrieve translation history for requested package', async () => {
		const response = await request.get(`/v2/packages/${translationData[0].id}/translationsHistory`);
		expect(response.status).to.deep.equal(200);
		expect(response.body).to.deep.equal(translationHistoryResponse);
	});

	it('Should return 404 if history for requested package does not exists', async () => {
		const response = await request.get('/v2/packages/123/translationsHistory');
		expect(response.status).to.deep.equal(404);
		expect(response.body.message).to.deep.equal('Translation history for package 123 was not found');
	});
});
					</code></pre>
				</section>

				<section>
					<h2>Unit</h2>
					<pre style="font-size: 12px; margin-top: 0;"><code class="hljs js" style="word-wrap: break-word;">
describe('[Unit-Tests] - V2 - shipping costs parser', () => {
	it('Should parse an integrations shipping cost', () => {
		const result = parser(integrationsShippingCost)
		expect(result).toEqual(ecommerceShippingCost)
	})
})
					</code></pre>
				</section>

				<section>
					<h2>Folders structure</h2>
					<img data-src="/images/21.png" alt="...">
					<img data-src="/images/22.png" alt="...">

					<aside class="notes">
						Input / output<br>
						No problems in huge refactoring of spaghetti code<br>
					</aside>
				</section>
			</section>

			<section>
				<h2>Thank you</h2>
				<img height="300" data-src="/images/23.gif" alt="...">
			</section>

		</div>

	</div>

	<script src="js/reveal.js"></script>

	<script>

		// More info https://github.com/hakimel/reveal.js#configuration
		Reveal.initialize({
			controls: true,
			progress: true,
			center: true,
			hash: true,

			transition: 'slide', // none/fade/slide/convex/concave/zoom

			// More info https://github.com/hakimel/reveal.js#dependencies
			dependencies: [
				{ src: 'plugin/markdown/marked.js', condition: function () { return !!document.querySelector('[data-markdown]'); } },
				{ src: 'plugin/markdown/markdown.js', condition: function () { return !!document.querySelector('[data-markdown]'); } },
				{ src: 'plugin/highlight/highlight.js' },
				{ src: 'plugin/search/search.js', async: true },
				{ src: 'plugin/zoom-js/zoom.js', async: true },
				{ src: 'plugin/notes/notes.js', async: true }
			]
		});

	</script>

</body>

</html>